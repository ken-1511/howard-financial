<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dashboard | Howard Financial</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --color-primary: #8338ec;
      --color-primary-light: #9c5ff2;
      --color-primary-dark: #6d1dd9;
      --color-secondary: #0A8754;
      --color-secondary-light: #10A76A;
      --color-secondary-dark: #076B42;
      --color-accent: #F28D35;
      --color-accent-light: #F6A25C;
      --color-accent-dark: #D77621;
      --color-error: #D64045;
      --color-error-light: #E06367;
      --color-error-dark: #B83035;
      --color-neutral: #3F88C5;
      --color-neutral-light: #5E9DD1;
      --color-neutral-dark: #2D6EA8;
      --color-withdrawal: #9C27B0;
      --color-withdrawal-light: #BA68C8;
      --color-withdrawal-dark: #7B1FA2;
      --color-background: #F6F8FA;
      --color-surface: #FFFFFF;
      --color-text-primary: #2C3E50;
      --color-text-secondary: #546E7A;
      --color-text-tertiary: #90A4AE;
      --color-border: #E1E8ED;
      --shadow-color: #8338ec20;
      
      /* Dark mode colors */
      --dark-color-background: #121212;
      --dark-color-surface: #1E1E1E;
      --dark-color-text-primary: #FFFFFF;
      --dark-color-text-secondary: #B0B0B0;
      --dark-color-text-tertiary: #777777;
      --dark-color-border: #333333;
    }
    
    * {
      font-family: 'Inter', sans-serif;
    }
    
    body {
      background: var(--color-background);
      color: var(--color-text-primary);
      transition: all 0.3s ease;
    }
    
    body.dark {
      background: var(--dark-color-background);
      color: var(--dark-color-text-primary);
    }
    
    body.dark .metric-card,
    body.dark .sidebar-nav {
      background: var(--dark-color-surface);
      border-color: var(--dark-color-border);
    }
    
    body.dark .text-gray-600 {
      color: var(--dark-color-text-secondary) !important;
    }
    
    body.dark .text-gray-500 {
      color: var(--dark-color-text-tertiary) !important;
    }
    
    .loading-skeleton {
      background: linear-gradient(90deg, #f0f0f0 25%, transparent 37%, #f0f0f0 63%);
      background-size: 400% 100%;
      animation: loading 1.4s ease infinite;
    }
    
    @keyframes loading {
      0% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }
    
    .card-hover {
      transition: all 0.3s ease;
    }
    
    .card-hover:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.08);
    }
    
    .metric-card {
      background: var(--color-surface);
      border-radius: 16px;
      padding: 24px;
      box-shadow: 0 4px 20px var(--shadow-color);
      border: 1px solid var(--color-border);
    }
    
    .sidebar-nav {
      background: var(--color-surface);
      border-right: 1px solid var(--color-border);
      box-shadow: 0 0 20px rgba(0, 0, 0, 0.03);
    }
    
    .nav-link {
      padding: 12px 20px;
      border-radius: 12px;
      margin: 0 8px;
      transition: all 0.2s ease;
      text-decoration: none;
      color: var(--color-text-secondary);
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .nav-link:hover {
      background: rgba(131, 56, 236, 0.05);
      color: var(--color-primary);
      text-decoration: none;
    }
    
    .nav-link.active {
      background: var(--color-primary);
      color: white;
    }
    
    .nav-link svg {
      width: 20px;
      height: 20px;
    }
    
    .brand-text {
      background: linear-gradient(135deg, var(--color-primary), var(--color-primary-light));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      font-weight: 700;
    }
    
    .metric-label {
      font-size: 0.75rem;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--color-text-secondary);
      margin-bottom: 8px;
    }
    
    .metric-value {
      font-size: 2rem;
      font-weight: 700;
      line-height: 1.2;
      margin-bottom: 4px;
    }
    
    .metric-trend {
      font-size: 0.875rem;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 4px;
    }
    
    .trend-positive {
      color: var(--color-secondary);
    }
    
    .trend-negative {
      color: var(--color-error);
    }
    
    .chart-card {
      background: var(--color-surface);
      border-radius: 16px;
      padding: 24px 24px 40px; 
      box-shadow: 0 4px 20px var(--shadow-color);
      margin-bottom: 40px;
    }
    
    .expense-chart-container {
      background: var(--color-surface);
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 4px 20px var(--shadow-color);
    }
    
    .expense-chart-header {
      background: rgba(131, 56, 236, 0.05);
      padding: 20px 24px;
      border-bottom: 1px solid var(--color-border);
    }
    
    .transaction-row {
      transition: background-color 0.2s ease;
      border-bottom: 1px solid var(--color-border);
    }
    
    .transaction-row:hover {
      background-color: rgba(131, 56, 236, 0.02);
    }
    
    .transaction-type-income {
      background: rgba(10, 135, 84, 0.1);
      color: var(--color-secondary-dark);
      padding: 4px 8px;
      border-radius: 6px;
      font-size: 0.75rem;
      font-weight: 500;
    }
    
    .transaction-type-expense {
      background: rgba(214, 64, 69, 0.1);
      color: var(--color-error-dark);
      padding: 4px 8px;
      border-radius: 6px;
      font-size: 0.75rem;
      font-weight: 500;
    }
    
    .transaction-type-reimbursement {
      background: rgba(63, 136, 197, 0.1);
      color: var(--color-neutral-dark);
      padding: 4px 8px;
      border-radius: 6px;
      font-size: 0.75rem;
      font-weight: 500;
    }
    
    .transaction-amount-positive {
      color: var(--color-secondary);
      font-weight: 600;
    }
    
    .transaction-amount-negative {
      color: var(--color-error);
      font-weight: 600;
    }
    
    .transaction-amount-neutral {
      color: var(--color-neutral);
      font-weight: 600;
    }
    
    .btn-primary {
      background: linear-gradient(135deg, var(--color-primary), var(--color-primary-light));
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 12px;
      font-weight: 500;
      transition: all 0.2s ease;
      cursor: pointer;
    }
    
    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 6px 20px rgba(131, 56, 236, 0.3);
    }
    
    .btn-secondary {
      background: rgba(131, 56, 236, 0.1);
      color: var(--color-primary);
      border: 1px solid rgba(131, 56, 236, 0.2);
      padding: 8px 16px;
      border-radius: 8px;
      font-weight: 500;
      transition: all 0.2s ease;
      cursor: pointer;
    }
    
    .btn-secondary:hover {
      background: rgba(131, 56, 236, 0.15);
    }
    
    .card-title {
      font-size: 0.875rem;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--color-text-secondary);
      margin-bottom: 16px;
    }
    
    .card-value {
      font-size: 1.75rem;
      font-weight: 700;
      margin-bottom: 8px;
    }
    
    .card-icon {
      width: 42px;
      height: 42px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 16px;
    }
    
    .overview-chart {
      background: var(--color-surface);
      border-radius: 16px;
      padding: 24px;
      box-shadow: 0 4px 20px var(--shadow-color);
      margin-bottom: 32px;
    }
    
    .data-visualization {
      position: relative;
      background: var(--color-surface);
      border-radius: 16px;
      padding: 24px;
      box-shadow: 0 4px 20px var(--shadow-color);
    }
    
    /* Responsive styles */
    @media (max-width: 768px) {
      .sidebar-nav {
        width: 100%;
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        height: 80px;
        border-right: none;
        border-top: 1px solid var(--color-border);
        height: auto;
        background-color: white;
        z-index: 100;
      }
      
      .nav-link {
        flex-direction: column;
        gap: 4px;
        padding: 8px;
        font-size: 0.75rem;
      }
      
      .nav-link svg {
        width: 18px;
        height: 18px;
      }
      
      main {
        margin-left: 0;
        padding-bottom: 100px;
      }
    }
    
    /* High contrast mode support */
    @media (forced-colors: active) {
      .card-hover:hover {
        border: 2px solid CanvasText;
      }
      
      .nav-link.active {
        border: 2px solid CanvasText;
      }
      
      .btn-primary {
        border: 1px solid CanvasText;
      }
    }
    
    /* Smooth scroll for anchor links */
    html {
      scroll-behavior: smooth;
    }
    
    /* Loading animation for data */
    .loading-data {
      animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    
    /* Chart responsive container */
    .chart-container {
      position: relative;
      height: 300px;
      width: 100%;
    }
    
    /* Mobile responsive adjustments */
    @media (max-width: 640px) {
      .metric-card {
        padding: 16px;
      }
      
      .metric-value {
        font-size: 1.5rem;
      }
      
      .metric-label {
        font-size: 0.625rem;
      }
      
      .chart-card {
        padding: 16px;
        margin-bottom: 24px;
      }
      
      .overview-chart {
        padding: 16px;
        margin-bottom: 24px;
      }
      
      .chart-container {
        height: 250px;
      }
      
      .card-icon {
        width: 36px;
        height: 36px;
      }
      
      .card-value {
        font-size: 1.25rem;
      }
      
      .card-title {
        font-size: 0.75rem;
      }
    }
    
    /* Focus styles for accessibility */
    .nav-link:focus,
    .btn-primary:focus,
    .btn-secondary:focus {
      outline: 2px solid var(--color-primary);
      outline-offset: 2px;
    }
    
    /* Print styles */
    @media print {
      .sidebar-nav {
        display: none;
      }
      
      main {
        margin-left: 0;
      }
      
      .card-hover:hover {
        transform: none;
        box-shadow: none;
      }
    }
    
    /* Reduce motion for accessibility */
    @media (prefers-reduced-motion: reduce) {
      * {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
      }
    }
  </style>
</head>
<body>
  <div class="flex min-h-screen">
    <!-- Sidebar -->
    <aside class="w-64 sidebar-nav">
      <div class="p-6">
        <div class="flex items-center gap-3 mb-8">
          <div class="w-10 h-10 bg-gradient-to-br from-purple-600 to-purple-700 rounded-xl flex items-center justify-center">
            <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"></path>
            </svg>
          </div>
          <span class="text-xl brand-text">Howard Financial</span>
        </div>
        
        <nav class="space-y-1">
          <a href="index.html" class="nav-link active">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
            </svg>
            Dashboard
          </a>
          <a href="settings/index.html" class="nav-link">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
            </svg>
            Settings
          </a>
          <a href="tools/index.html" class="nav-link">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            Add Tool
          </a>
        </nav>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 p-8 ml-64">
      <!-- Header -->
      <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-900 dark:text-white">Financial Overview</h1>
        <p class="text-gray-600 dark:text-gray-300 mt-2">Track your finances and make informed decisions</p>
      </div>

      <!-- Loading Skeleton (shown initially) -->
      <div id="loadingSkeleton" class="space-y-6">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
          <div class="metric-card loading-skeleton h-32"></div>
          <div class="metric-card loading-skeleton h-32"></div>
          <div class="metric-card loading-skeleton h-32"></div>
        </div>
        <div class="chart-card loading-skeleton h-80"></div>
      </div>

      <!-- Metrics Grid (hidden initially) -->
      <div id="metricsGrid" class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8" style="display: none;">
        <div class="metric-card card-hover">
          <div class="metric-label">Total Income</div>
          <div class="metric-value text-green-600" id="totalIncome">$0.00</div>
          <div class="metric-trend" id="incomeTrend">
            <span class="text-sm text-gray-500">Monthly average: $0.00</span>
          </div>
        </div>
        
        <div class="metric-card card-hover">
          <div class="metric-label">Total Expenses</div>
          <div class="metric-value text-red-600" id="totalExpenses">$0.00</div>
          <div class="metric-trend" id="expensesTrend">
            <span class="text-sm text-gray-500">Monthly average: $0.00</span>
          </div>
        </div>
        
        <div class="metric-card card-hover">
          <div class="metric-label">Net Balance</div>
          <div class="metric-value" id="netBalance">$0.00</div>
          <div class="metric-trend" id="balanceTrend">
            <span class="text-sm text-gray-500">Monthly average: $0.00</span>
          </div>
        </div>
      </div>

      <!-- Financial Trends Chart -->
      <div id="chartContainer" class="chart-card" style="display: none;">
        <div class="flex justify-between items-center mb-6">
          <h2 class="text-xl font-semibold">Financial Trends</h2>
          <div class="flex items-center gap-4">
            <!-- Time Period Buttons -->
            <div class="flex gap-1 bg-gray-100 dark:bg-gray-800 rounded-lg p-1">
              <button id="period30D" class="period-btn px-3 py-1 rounded text-sm font-medium transition-colors bg-white dark:bg-gray-700 text-purple-600 shadow-sm" data-period="30">30D</button>
              <button id="period90D" class="period-btn px-3 py-1 rounded text-sm font-medium transition-colors text-gray-600 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700" data-period="90">90D</button>
              <button id="period360D" class="period-btn px-3 py-1 rounded text-sm font-medium transition-colors text-gray-600 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700" data-period="360">360D</button>
            </div>
            <!-- Legend -->
            <div class="flex gap-2">
              <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800">
                <span class="w-2 h-2 mr-2 bg-green-500 rounded-full"></span>
                Income
              </span>
              <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-red-100 text-red-800">
                <span class="w-2 h-2 mr-2 bg-red-500 rounded-full"></span>
                Expenses
              </span>
              <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                <span class="w-2 h-2 mr-2 bg-blue-500 rounded-full"></span>
                Balance
              </span>
            </div>
          </div>
        </div>
        <div class="chart-container">
          <canvas id="financialChart" style="display: block; height: 300px;"></canvas>
        </div>
      </div>

      <!-- Expense Breakdown -->
      <div id="expenseBreakdownContainer" class="expense-chart-container" style="display: none;">
        <div class="expense-chart-header">
          <h2 class="text-xl font-semibold">Expense Breakdown</h2>
          <p class="text-gray-600 dark:text-gray-300 text-sm">Your spending by category</p>
        </div>
        
        <!-- Side by Side Layout: Chart with Legend | Analysis -->
        <div class="flex flex-col lg:flex-row min-h-96">
          <!-- Left Side: Chart and Legend -->
          <div class="lg:w-1/2 p-6 flex flex-col lg:flex-row items-center">
            <!-- Pie Chart (Smaller) -->
            <div class="flex-shrink-0">
              <div class="chart-container" style="height: 280px; width: 280px;">
                <canvas id="expenseChart" style="display: block;"></canvas>
              </div>
            </div>
            
            <!-- Vertical Legend -->
            <div class="ml-6 flex-1">
              <h4 class="font-medium text-sm text-gray-700 dark:text-gray-300 mb-3">Categories</h4>
              <div id="categoryLegend" class="space-y-2 max-h-64 overflow-y-auto">
                <!-- Dynamic legend will be inserted here -->
              </div>
            </div>
          </div>
          
          <!-- Right Side: Category Analysis -->
          <div class="lg:w-1/2 p-6 border-l border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-800">
            <h3 class="text-lg font-medium mb-4">Detailed Analysis</h3>
            <div id="categoryAnalysis" class="space-y-3 max-h-80 overflow-y-auto pr-2">
              <!-- Dynamic content will be inserted here -->
            </div>
          </div>
        </div>
      </div>

      <!-- Recent Transactions -->
      <div id="transactionsContainer" class="overview-chart" style="display: none;">
        <div class="flex justify-between items-center mb-6">
          <h2 class="text-xl font-semibold">Recent Transactions</h2>
          <select id="categoryFilter" class="px-3 py-2 border border-gray-300 rounded-lg text-sm">
            <option value="">All Categories</option>
          </select>
        </div>
        
        <div class="overflow-x-auto">
          <table class="w-full">
            <thead>
              <tr class="text-left text-sm font-medium text-gray-500 dark:text-gray-400 border-b border-gray-200 dark:border-gray-700">
                <th class="pb-3">DATE</th>
                <th class="pb-3">TYPE</th>
                <th class="pb-3">CATEGORY</th>
                <th class="pb-3">AMOUNT</th>
                <th class="pb-3">VENDOR</th>
                <th class="pb-3">BALANCE</th>
              </tr>
            </thead>
            <tbody id="transactionTableBody">
              <!-- Dynamic content will be inserted here -->
            </tbody>
          </table>
        </div>
        
        <!-- Pagination -->
        <div id="paginationContainer" class="flex justify-between items-center mt-6">
          <div class="text-sm text-gray-500" id="paginationInfo">
            Showing 0 of 0 transactions
          </div>
          <div class="flex gap-2" id="paginationControls">
            <!-- Dynamic pagination controls will be inserted here -->
          </div>
        </div>
      </div>
    </main>
  </div>
  
  <script>
    // Global variables
    let allTransactions = [];
    let filteredTransactions = [];
    let currentPage = 1;
    const transactionsPerPage = 100;
    let financialChart = null;
    let expenseChart = null;
    let currentTimePeriod = 30; // Default to 30 days

    // Load settings on page load
    document.addEventListener('DOMContentLoaded', function() {
      loadSettings();
      loadDataFromAPI();
      setupTimePeriodButtons();
    });

    function loadSettings() {
      // Apply dark mode
      const savedDarkMode = localStorage.getItem('darkMode');
      if (savedDarkMode === 'true') {
        document.body.classList.add('dark');
      }

      // Apply theme color
      const savedThemeColor = localStorage.getItem('themeColor');
      const savedThemeColorLight = localStorage.getItem('themeColorLight');
      const savedThemeColorDark = localStorage.getItem('themeColorDark');
      
      if (savedThemeColor && savedThemeColorLight && savedThemeColorDark) {
        document.documentElement.style.setProperty('--color-primary', savedThemeColor);
        document.documentElement.style.setProperty('--color-primary-light', savedThemeColorLight);
        document.documentElement.style.setProperty('--color-primary-dark', savedThemeColorDark);
        document.documentElement.style.setProperty('--shadow-color', savedThemeColor + '20');
      }

      // Apply font size
      const savedFontSize = localStorage.getItem('fontSize');
      if (savedFontSize) {
        const htmlEl = document.documentElement;
        switch(savedFontSize) {
          case '1':
            htmlEl.style.fontSize = '14px';
            break;
          case '2':
            htmlEl.style.fontSize = '16px';
            break;
          case '3':
            htmlEl.style.fontSize = '18px';
            break;
          default:
            htmlEl.style.fontSize = '16px';
        }
      }
    }

    // API Configuration
    const API_BASE_URL = 'http://localhost:8000/api/v1';
    
    async function loadDataFromAPI() {
      console.log('Loading data from API...');
      
      try {
        // Load transactions
        const transactionsResponse = await fetch(`${API_BASE_URL}/transactions`);
        const transactionsData = await transactionsResponse.json();
        allTransactions = transactionsData.transactions;
        filteredTransactions = allTransactions;
        
        // Load summary data
        const summaryResponse = await fetch(`${API_BASE_URL}/summary`);
        const summaryData = await summaryResponse.json();
        
        // Hide loading skeleton and show content
        document.getElementById('loadingSkeleton').style.display = 'none';
        document.getElementById('metricsGrid').style.display = 'grid';
        document.getElementById('chartContainer').style.display = 'block';
        document.getElementById('expenseBreakdownContainer').style.display = 'block';
        document.getElementById('transactionsContainer').style.display = 'block';
        
        // Update all displays
        updateMetricsFromAPI(summaryData);
        updateFinancialChart();
        updateExpenseBreakdown();
        updateTransactionTable();
        populateCategoryFilter();
        
      } catch (error) {
        console.error('Error loading data from API:', error);
        hideLoadingAndShowError();
      }
    }

    function updateMetricsFromAPI(summaryData) {
      console.log('Updating metrics from API data...');
      
      // Update DOM with API data
      document.getElementById('totalIncome').textContent = formatCurrency(summaryData.total_income);
      document.getElementById('totalExpenses').textContent = formatCurrency(summaryData.total_expenses);
      document.getElementById('netBalance').textContent = formatCurrency(summaryData.net_income);
      
      // Update net balance color
      const balanceElement = document.getElementById('netBalance');
      if (summaryData.net_income > 0) {
        balanceElement.className = 'metric-value text-green-600';
      } else if (summaryData.net_income < 0) {
        balanceElement.className = 'metric-value text-red-600';
      } else {
        balanceElement.className = 'metric-value text-gray-600';
      }
      
      // Store the calculated balance for later use
      window.calculatedNetBalance = summaryData.net_income;
      
      // Update transaction count
      document.getElementById('transactionCount').textContent = summaryData.transaction_count.toLocaleString();
      
      // Calculate monthly averages
      const monthCount = Math.max(1, Math.ceil(summaryData.transaction_count / 30)); // Rough estimate
      const monthlyIncome = summaryData.total_income / monthCount;
      const monthlyExpenses = summaryData.total_expenses / monthCount;
      const monthlyBalance = summaryData.net_income / monthCount;
      
      document.getElementById('monthlyIncome').textContent = formatCurrency(monthlyIncome);
      document.getElementById('monthlyExpenses').textContent = formatCurrency(monthlyExpenses);
      document.getElementById('monthlyBalance').textContent = formatCurrency(monthlyBalance);
      
      // Update trend indicators
      updateTrendIndicators(summaryData);
    }

    function updateTrendIndicators(summaryData) {
      // Simple trend calculation based on monthly trends
      const monthlyTrends = summaryData.monthly_trends;
      if (monthlyTrends.length >= 2) {
        const currentMonth = monthlyTrends[monthlyTrends.length - 1].amount;
        const previousMonth = monthlyTrends[monthlyTrends.length - 2].amount;
        
        const incomeTrend = currentMonth > previousMonth ? 'up' : 'down';
        const expenseTrend = currentMonth < previousMonth ? 'up' : 'down';
        
        // Update trend indicators in the UI
        updateTrendIndicator('incomeTrend', incomeTrend);
        updateTrendIndicator('expenseTrend', expenseTrend);
      }
    }

    function updateTrendIndicator(elementId, trend) {
      const element = document.getElementById(elementId);
      if (element) {
        element.className = `trend-indicator ${trend === 'up' ? 'trend-up' : 'trend-down'}`;
        element.innerHTML = trend === 'up' ? '↗' : '↘';
      }
    }

    function hideLoadingAndShowError() {
      document.getElementById('loadingSkeleton').style.display = 'none';
      const errorMessage = document.createElement('div');
      errorMessage.className = 'metric-card text-center py-8';
      errorMessage.innerHTML = `
        <div class="text-red-600 mb-2">
          <svg class="w-12 h-12 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.866-.833-2.464 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
          </svg>
        </div>
        <h3 class="text-lg font-semibold mb-2">Unable to Load Data</h3>
        <p class="text-gray-600">Please check if the API server is running on localhost:8000.</p>
        <button onclick="loadDataFromAPI()" class="mt-4 px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors">
          Retry
        </button>
      `;
      document.querySelector('main').appendChild(errorMessage);
    }

    function updateMetrics() {
      console.log('Updating metrics...');
      let totalIncome = 0;
      let totalExpenses = 0;
      let netBalance = 0;

      // Filter out transfers for calculations
      const validTransactions = allTransactions.filter(t => 
        t.Type && t.Type.toLowerCase() !== 'transfer'
      );

      validTransactions.forEach(transaction => {
        const amount = parseFloat(transaction.Dollars?.replace(/[$,]/g, '') || 0);
        const type = transaction.Type?.toLowerCase();
        
        if (type === 'income') {
          totalIncome += amount;
          netBalance += amount;
        } else if (type === 'expense') {
          totalExpenses += amount;
          netBalance -= amount;
        } else if (type === 'reimbursement') {
          netBalance += amount;
        }
      });

      // Calculate monthly averages
      const months = getUniqueMonths(validTransactions);
      const monthCount = months.length || 1;
      
      const monthlyIncome = totalIncome / monthCount;
      const monthlyExpenses = totalExpenses / monthCount;
      const monthlyBalance = netBalance / monthCount;

      // Update DOM
      document.getElementById('totalIncome').textContent = formatCurrency(totalIncome);
      document.getElementById('totalExpenses').textContent = formatCurrency(totalExpenses);
      document.getElementById('netBalance').textContent = formatCurrency(netBalance);
      
      // Update net balance color
      const balanceElement = document.getElementById('netBalance');
      if (netBalance > 0) {
        balanceElement.className = 'metric-value text-green-600';
      } else if (netBalance < 0) {
        balanceElement.className = 'metric-value text-red-600';
      } else {
        balanceElement.className = 'metric-value text-gray-600';
      }

      // Update trend information
      document.getElementById('incomeTrend').innerHTML = `<span class="text-sm text-gray-500">Monthly average: ${formatCurrency(monthlyIncome)}</span>`;
      document.getElementById('expensesTrend').innerHTML = `<span class="text-sm text-gray-500">Monthly average: ${formatCurrency(monthlyExpenses)}</span>`;
      document.getElementById('balanceTrend').innerHTML = `<span class="text-sm text-gray-500">Monthly average: ${formatCurrency(monthlyBalance)}</span>`;
    }

    function getUniqueMonths(transactions) {
      const months = new Set();
      transactions.forEach(transaction => {
        if (transaction.Date) {
          const date = new Date(transaction.Date);
          const monthKey = `${date.getFullYear()}-${date.getMonth()}`;
          months.add(monthKey);
        }
      });
      return Array.from(months);
    }

    function updateFinancialChart() {
      console.log('Updating financial chart for period:', currentTimePeriod);
      
      // Sort all transactions by date (earliest first) to calculate proper running total
      const allSortedTransactions = allTransactions
        .filter(t => t.date && t.type && t.type.toLowerCase() !== 'transfer')
        .sort((a, b) => new Date(a.date) - new Date(b.date));

      // Find the first positive amount and start balance calculation from there
      let runningBalance = 0;
      let foundFirstPositive = false;
      
      const transactionsWithBalance = allSortedTransactions.map(transaction => {
        const amount = transaction.amount; // API already provides numeric amount
        const type = transaction.type?.toLowerCase();
        
        // Initialize balance with first positive amount
        if (!foundFirstPositive && amount > 0) {
          runningBalance = amount;
          foundFirstPositive = true;
        } else if (foundFirstPositive) {
          // For subsequent transactions, add positive amounts and subtract negative amounts
          if (amount > 0) {
            runningBalance += amount;
          } else {
            runningBalance += amount; // amount is already negative for expenses
          }
        }
        
        return {
          ...transaction,
          runningBalance: foundFirstPositive ? runningBalance : 0
        };
      });

      // Filter transactions based on time period
      const cutoffDate = new Date();
      cutoffDate.setDate(cutoffDate.getDate() - currentTimePeriod);
      
      const validTransactions = transactionsWithBalance.filter(t => {
        const transactionDate = new Date(t.date);
        return transactionDate >= cutoffDate;
      });

      // Group transactions by day for better granularity
      const dailyData = {};
      
      validTransactions.forEach(transaction => {
        if (transaction.date) {
          const date = new Date(transaction.date);
          const dayKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
          
          if (!dailyData[dayKey]) {
            dailyData[dayKey] = { income: 0, expenses: 0, balance: transaction.runningBalance };
          }
          
          const amount = transaction.amount; // API already provides numeric amount
          const type = transaction.type?.toLowerCase();
          
          if (type === 'income') {
            dailyData[dayKey].income += amount;
          } else if (type === 'expense') {
            dailyData[dayKey].expenses += amount;
          }
          
          // Use the actual running balance from calculations
          dailyData[dayKey].balance = transaction.runningBalance;
        }
      });

      // Sort days and prepare chart data
      const sortedDays = Object.keys(dailyData).sort();
      const labels = sortedDays.map(day => {
        const [year, month, dayNum] = day.split('-');
        const date = new Date(year, month - 1, dayNum);
        if (currentTimePeriod <= 30) {
          return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        } else if (currentTimePeriod <= 90) {
          return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        } else {
          return date.toLocaleDateString('en-US', { month: 'short', year: '2-digit' });
        }
      });

      const incomeData = sortedDays.map(day => dailyData[day].income);
      const expenseData = sortedDays.map(day => dailyData[day].expenses);
      const balanceData = sortedDays.map(day => dailyData[day].balance);

      // Destroy existing chart if it exists
      if (financialChart) {
        financialChart.destroy();
      }

      const ctx = document.getElementById('financialChart').getContext('2d');
      financialChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [
            {
              label: 'Income',
              data: incomeData,
              borderColor: '#10A76A',
              backgroundColor: 'rgba(16, 167, 106, 0.1)',
              fill: true,
              tension: 0.4
            },
            {
              label: 'Expenses',
              data: expenseData,
              borderColor: '#D64045',
              backgroundColor: 'rgba(214, 64, 69, 0.1)',
              fill: true,
              tension: 0.4
            },
            {
              label: 'Balance',
              data: balanceData,
              borderColor: '#3F88C5',
              backgroundColor: 'rgba(63, 136, 197, 0.1)',
              fill: true,
              tension: 0.4
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: {
            intersect: false,
            mode: 'index'
          },
          plugins: {
            legend: {
              display: false
            },
            tooltip: {
              backgroundColor: 'rgba(255, 255, 255, 0.95)',
              titleColor: '#2C3E50',
              bodyColor: '#546E7A',
              borderColor: '#E1E8ED',
              borderWidth: 1,
              cornerRadius: 8,
              displayColors: true,
              callbacks: {
                label: function(context) {
                  return `${context.dataset.label}: ${formatCurrency(context.parsed.y)}`;
                }
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              grid: {
                color: 'rgba(0, 0, 0, 0.05)'
              },
              ticks: {
                callback: function(value) {
                  return formatCurrency(value);
                }
              }
            },
            x: {
              grid: {
                display: false
              }
            }
          }
        }
      });
    }

    function updateExpenseBreakdown() {
      console.log('Starting updateExpenseBreakdown...');
      
      // Filter for expenses only
      const expenseTransactions = allTransactions.filter(t => 
        t.Type && t.Type.toLowerCase() === 'expense' && t.Category
      );

      // Group expenses by category
      const categoryExpenses = {};
      const monthlyCategoryCounts = {};

      expenseTransactions.forEach(transaction => {
        const category = transaction.Category.trim();
        const amount = parseFloat(transaction.Dollars?.replace(/[$,]/g, '') || 0);
        
        if (!categoryExpenses[category]) {
          categoryExpenses[category] = 0;
          monthlyCategoryCounts[category] = 0;
        }
        
        categoryExpenses[category] += amount;
        monthlyCategoryCounts[category] += 1;
      });

      console.log('Category Data:', {categoryExpenses, monthlyCategoryCounts});
      
      // Call the chart update function
      updateExpenseBreakdownChart({categoryExpenses, monthlyCategoryCounts});
    }

    function updateExpenseBreakdownChart(data) {
      console.log('Starting updateExpenseBreakdown with:', data);
      const {categoryExpenses, monthlyCategoryCounts} = data;
      
      if (!categoryExpenses || Object.keys(categoryExpenses).length === 0) {
        console.error('No category expense data available');
        return;
      }

      // Convert to arrays and sort by amount
      const categories = Object.keys(categoryExpenses);
      const amounts = categories.map(cat => categoryExpenses[cat]);
      
      // Sort categories by expense amount (descending)
      const sortedData = categories
        .map((cat, index) => ({ category: cat, amount: amounts[index] }))
        .sort((a, b) => b.amount - a.amount);

      // Group smaller categories into "Other"
      const topCategories = sortedData.slice(0, 9);
      const otherCategories = sortedData.slice(9);
      
      let expenseGroups = topCategories.map(item => item.category);
      let expenseValues = topCategories.map(item => item.amount);
      let expenseDisplayGroups = [...expenseGroups];

      if (otherCategories.length > 0) {
        const otherTotal = otherCategories.reduce((sum, item) => sum + item.amount, 0);
        expenseGroups.push('Other');
        expenseValues.push(otherTotal);
        expenseDisplayGroups.push('Other');
      }

      // Group categories into meaningful categories
      const categoryMapping = {
        'Substances': ['alcohol', 'nicotine', 'cbd', 'thc', 'tobacco', 'beer', 'wine', 'liquor', 'cigarettes', 'vape', 'marijuana', 'cannabis'],
        'Housing': ['furniture', 'rent', 'utilities', 'electric', 'water', 'gas', 'internet', 'cable', 'phone', 'home', 'property', 'mortgage', 'wifi'],
        'Transportation': ['transportation', 'parking', 'gas', 'fuel', 'car', 'vehicle', 'uber', 'lyft', 'taxi', 'bus', 'train', 'metro'],
        'Health & Wellness': ['health', 'wellness', 'medical', 'doctor', 'pharmacy', 'medicine', 'fitness', 'gym', 'therapy', 'dental', 'vision'],
        'Business & Gifts': ['business', 'gifts', 'office', 'supplies', 'work', 'gift', 'present', 'donation', 'charity'],
        'Investing & Education': ['investing', 'education', 'investment', 'stocks', 'bonds', 'crypto', 'school', 'tuition', 'books', 'course', 'training'],
        'Subscription & Entertainment': ['subscription', 'entertainment', 'netflix', 'spotify', 'streaming', 'movie', 'music', 'game', 'fun', 'leisure'],
        'Other': ['error', 'other', 'unknown', 'misc', 'miscellaneous', 'uncategorized']
      };

      const groupedExpenses = {};
      const categoryDetails = {}; // Track which original categories fall under each group
      
      categories.forEach(category => {
        const lowerCategory = category.toLowerCase();
        let grouped = false;
        
        for (const [group, keywords] of Object.entries(categoryMapping)) {
          if (keywords.some(keyword => lowerCategory.includes(keyword))) {
            if (!groupedExpenses[group]) {
              groupedExpenses[group] = 0;
              categoryDetails[group] = [];
            }
            groupedExpenses[group] += categoryExpenses[category];
            categoryDetails[group].push(category);
            grouped = true;
            break;
          }
        }
        
        if (!grouped) {
          const displayCategory = category.length > 20 ? category.substring(0, 20) + '...' : category;
          if (!groupedExpenses[displayCategory]) {
            groupedExpenses[displayCategory] = 0;
            categoryDetails[displayCategory] = [];
          }
          groupedExpenses[displayCategory] += categoryExpenses[category];
          categoryDetails[displayCategory].push(category);
        }
      });

      console.log('Grouped expenses:', groupedExpenses);
      console.log('Category details:', categoryDetails);

      // Prepare final chart data
      expenseGroups = Object.keys(groupedExpenses);
      expenseValues = Object.values(groupedExpenses);
      expenseDisplayGroups = expenseGroups;

      // Store category details for analysis
      window.categoryDetails = categoryDetails;

      console.log('Chart data:', {expenseGroups, expenseValues, expenseDisplayGroups});

      // Colors for the pie chart - more distinct color palette with better contrast
      const colors = [
        '#FF6B6B', // Red
        '#1E88E5', // Blue
        '#43A047', // Green
        '#8E24AA', // Purple
        '#FFA726', // Orange
        '#26C6DA', // Cyan
        '#D81B60', // Pink
        '#5E35B1', // Deep Purple
        '#2E7D32', // Dark Green
        '#EF5350', // Light Red
        '#7E57C2', // Moderate Purple
        '#26A69A', // Teal
        '#F57F17', // Amber
        '#00ACC1', // Light Blue
        '#5D4037'  // Brown
      ];

      // Destroy existing chart if it exists
      if (expenseChart) {
        expenseChart.destroy();
      }

      // Create pie chart
      const ctx = document.getElementById('expenseChart').getContext('2d');
      expenseChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: expenseDisplayGroups,
          datasets: [{
            data: expenseValues,
            backgroundColor: colors.slice(0, expenseValues.length),
            borderWidth: 2,
            borderColor: '#ffffff',
            hoverOffset: 15, // Make hovered section larger
            hoverBorderWidth: 3
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: false // Hide default legend since we're creating custom
            },
            tooltip: {
              backgroundColor: 'rgba(255, 255, 255, 0.95)',
              titleColor: '#2C3E50',
              bodyColor: '#546E7A',
              borderColor: '#E1E8ED',
              borderWidth: 1,
              cornerRadius: 8,
              padding: 10,
              titleFont: {
                weight: 'bold',
                size: 14
              },
              callbacks: {
                label: function(context) {
                  const total = context.dataset.data.reduce((a, b) => a + b, 0);
                  const percentage = ((context.parsed / total) * 100).toFixed(1);
                  return `${context.label}: ${formatCurrency(context.parsed)} (${percentage}%)`;
                }
              }
            }
          },
          cutout: '55%',
          animation: {
            animateScale: true,
            animateRotate: true
          }
        }
      });

      // Update category analysis and legend
      updateCategoryAnalysis(expenseGroups, expenseValues, expenseDisplayGroups);
      updateCategoryLegend(expenseGroups, expenseValues, expenseDisplayGroups, colors);
    }

    function updateCategoryAnalysis(categories, amounts, displayCategories) {
      const analysisContainer = document.getElementById('categoryAnalysis');
      const total = amounts.reduce((a, b) => a + b, 0);
      
      let analysisHTML = '';
      
      // Show all categories with detailed breakdown and descriptions
      categories.forEach((category, index) => {
        const amount = amounts[index];
        const percentage = ((amount / total) * 100).toFixed(1);
        const displayName = displayCategories[index];
        
        // Use the same color array as the chart for consistency
        const colors = [
          '#FF6B6B', '#1E88E5', '#43A047', '#8E24AA', '#FFA726', 
          '#26C6DA', '#D81B60', '#5E35B1', '#2E7D32', '#EF5350',
          '#7E57C2', '#26A69A', '#F57F17', '#00ACC1', '#5D4037'
        ];
        const color = colors[index % colors.length];
        
        // Get subcategories for this group
        const subcategories = window.categoryDetails && window.categoryDetails[category] ? window.categoryDetails[category] : [];
        
        // Count transactions for each category
        let transactionCount = 0;
        subcategories.forEach(subcat => {
          const subcatTransactions = allTransactions.filter(t => t.Category === subcat && t.Type?.toLowerCase() === 'expense').length;
          transactionCount += subcatTransactions;
        });
        
        // If no subcategories or couldn't count, count directly
        if (transactionCount === 0 && subcategories.length === 0) {
          transactionCount = allTransactions.filter(t => t.Category === category && t.Type?.toLowerCase() === 'expense').length;
        }
        
        // Get category description
        const categoryDescriptions = {
          'Substances': 'Alcohol, nicotine, CBD/THC and related consumables',
          'Housing': 'Rent, utilities, furniture, wifi and property costs',
          'Transportation': 'Vehicle, parking and public transit expenses',
          'Health & Wellness': 'Medical, fitness and therapy expenses',
          'Business & Gifts': 'Work-related items, gifts and donations',
          'Investing & Education': 'Investments, courses and educational expenses',
          'Subscription & Entertainment': 'Streaming services and leisure activities',
          'Other': 'Miscellaneous and uncategorized expenses'
        };
        
        const description = categoryDescriptions[category] || `${displayName} expenses`;
        
        analysisHTML += `
          <div class="bg-white dark:bg-gray-900 rounded-lg shadow-sm border border-gray-100 dark:border-gray-700 p-4 mb-3">
            <div class="flex items-center justify-between mb-2">
              <div class="flex items-center gap-2">
                <div class="w-3 h-3 rounded-full" style="background-color: ${color}"></div>
                <span class="font-semibold text-sm">${displayName}</span>
                <span class="text-xs text-gray-500 dark:text-gray-400">(${transactionCount} txns)</span>
              </div>
              <div class="text-right">
                <div class="text-sm font-bold">${formatCurrency(amount)}</div>
                <div class="text-xs font-bold" style="color: ${color}">${percentage}%</div>
              </div>
            </div>
            
            <div class="text-xs text-gray-600 dark:text-gray-400 mb-2">${description}</div>
            
            <div class="w-full bg-gray-100 dark:bg-gray-700 rounded-full h-1.5">
              <div class="h-1.5 rounded-full" style="width: ${percentage}%; background-color: ${color}"></div>
            </div>
            
            ${subcategories.length > 0 ? `
              <div class="mt-2 text-xs text-gray-500 dark:text-gray-400">
                <span class="font-medium">Includes:</span> ${subcategories.slice(0, 4).join(', ')}${subcategories.length > 4 ? ` +${subcategories.length - 4} more` : ''}
              </div>
            ` : ''}
          </div>
        `;
      });

      analysisContainer.innerHTML = analysisHTML;
    }

    function updateCategoryLegend(categories, amounts, displayCategories, colors) {
      const legendContainer = document.getElementById('categoryLegend');
      const total = amounts.reduce((a, b) => a + b, 0);
      
      let legendHTML = '';
      
      categories.forEach((category, index) => {
        const amount = amounts[index];
        const percentage = ((amount / total) * 100).toFixed(1);
        const displayName = displayCategories[index];
        const color = colors[index % colors.length];
        
        legendHTML += `
          <div class="flex items-center justify-between py-1 px-2 rounded hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
            <div class="flex items-center gap-2">
              <div class="w-3 h-3 rounded-full flex-shrink-0" style="background-color: ${color}"></div>
              <span class="text-sm font-medium text-gray-700 dark:text-gray-300 truncate">${displayName}</span>
            </div>
            <div class="text-right ml-2">
              <div class="text-sm font-bold" style="color: ${color}">${percentage}%</div>
              <div class="text-xs text-gray-500 dark:text-gray-400">${formatCurrency(amount)}</div>
            </div>
          </div>
        `;
      });
      
      legendContainer.innerHTML = legendHTML;
    }

    function updateTransactionTable() {
      console.log('Updating transaction table...');
      const tableBody = document.getElementById('transactionTableBody');
      
      // Calculate pagination
      const totalTransactions = filteredTransactions.length;
      const startIndex = (currentPage - 1) * transactionsPerPage;
      const endIndex = Math.min(startIndex + transactionsPerPage, totalTransactions);

      // Sort all filtered transactions by date (earliest first) for balance calculation
      const sortedTransactions = [...filteredTransactions].sort((a, b) => new Date(a.date) - new Date(b.date));
      
      // Calculate running balance for all transactions first
      let runningBalance = 0;
      let foundFirstPositive = false;
      
      const transactionsWithBalance = sortedTransactions.map(transaction => {
        const amount = transaction.amount; // API already provides numeric amount
        const type = transaction.type?.toLowerCase();
        
        // Initialize balance with first positive amount (income)
        if (!foundFirstPositive && amount > 0 && type === 'income') {
          runningBalance = amount;
          foundFirstPositive = true;
        } else if (foundFirstPositive) {
          // For subsequent transactions, add income and subtract expenses
          if (type === 'income' || type === 'reimbursement') {
            runningBalance += amount;
          } else if (type === 'expense') {
            runningBalance -= amount;
          }
        }
        
        return {
          ...transaction,
          calculatedBalance: foundFirstPositive ? runningBalance : 0
        };
      });
      
      // Sort back to newest first for display but keep calculated balances
      const displayTransactions = transactionsWithBalance.sort((a, b) => new Date(b.date) - new Date(a.date));
      const pageTransactions = displayTransactions.slice(startIndex, endIndex);

      let tableHTML = '';
      pageTransactions.forEach(transaction => {
        const amount = transaction.amount; // API already provides numeric amount
        const type = transaction.type?.toLowerCase() || '';
        
        let typeClass = '';
        let amountClass = '';
        
        switch(type) {
          case 'income':
            typeClass = 'transaction-type-income';
            amountClass = 'transaction-amount-positive';
            break;
          case 'expense':
            typeClass = 'transaction-type-expense';
            amountClass = 'transaction-amount-negative';
            break;
          case 'reimbursement':
            typeClass = 'transaction-type-reimbursement';
            amountClass = 'transaction-amount-neutral';
            break;
          default:
            typeClass = 'transaction-type-expense';
            amountClass = 'transaction-amount-negative';
        }

        const formattedAmount = type === 'expense' ? `-${formatCurrency(amount)}` : 
                              type === 'income' ? `+${formatCurrency(amount)}` : 
                              `+${formatCurrency(amount)}`;

        tableHTML += `
          <tr class="transaction-row">
            <td class="py-3 text-sm">${formatDate(transaction.date)}</td>
            <td class="py-3">
              <span class="${typeClass}">${transaction.type || 'N/A'}</span>
            </td>
            <td class="py-3 text-sm">${transaction.category || 'N/A'}</td>
            <td class="py-3 text-sm font-medium ${amountClass}">${formattedAmount}</td>
            <td class="py-3 text-sm">${transaction.vendor || 'N/A'}</td>
            <td class="py-3 text-sm font-medium text-blue-600">${formatCurrency(transaction.calculatedBalance)}</td>
          </tr>
        `;
      });
      
      // Store the final balance for updating metrics
      if (transactionsWithBalance.length > 0) {
        const latestTransaction = transactionsWithBalance[transactionsWithBalance.length - 1];
        window.calculatedNetBalance = latestTransaction.calculatedBalance;
      }

      tableBody.innerHTML = tableHTML;
      updatePagination(totalTransactions);
    }

    function updateNetBalanceMetric() {
      if (window.calculatedNetBalance !== undefined) {
        const balanceElement = document.getElementById('netBalance');
        if (balanceElement) {
          balanceElement.textContent = formatCurrency(window.calculatedNetBalance);
          
          // Update balance color based on value
          if (window.calculatedNetBalance > 0) {
            balanceElement.className = 'metric-value text-green-600';
          } else if (window.calculatedNetBalance < 0) {
            balanceElement.className = 'metric-value text-red-600';
          } else {
            balanceElement.className = 'metric-value text-gray-600';
          }
        }
      }
    }

    function updatePagination(totalTransactions) {
      const paginationInfo = document.getElementById('paginationInfo');
      const paginationControls = document.getElementById('paginationControls');
      
      const startIndex = (currentPage - 1) * transactionsPerPage;
      const endIndex = Math.min(startIndex + transactionsPerPage, totalTransactions);
      
      paginationInfo.textContent = `Showing ${Math.min(transactionsPerPage, totalTransactions)} of ${totalTransactions} transactions`;
      
      const totalPages = Math.ceil(totalTransactions / transactionsPerPage);
      let controlsHTML = '';
      
      // Previous button
      if (currentPage > 1) {
        controlsHTML += `<button onclick="changePage(${currentPage - 1})" class="px-3 py-1 bg-gray-100 hover:bg-gray-200 rounded text-sm transition-colors">Previous</button>`;
      }
      
      // Page numbers (show current page and nearby pages)
      const startPage = Math.max(1, currentPage - 2);
      const endPage = Math.min(totalPages, currentPage + 2);
      
      for (let i = startPage; i <= endPage; i++) {
        const activeClass = i === currentPage ? 'bg-purple-600 text-white' : 'bg-gray-100 hover:bg-gray-200';
        controlsHTML += `<button onclick="changePage(${i})" class="px-3 py-1 ${activeClass} rounded text-sm transition-colors">${i}</button>`;
      }
      
      // Next button
      if (currentPage < totalPages) {
        controlsHTML += `<button onclick="changePage(${currentPage + 1})" class="px-3 py-1 bg-gray-100 hover:bg-gray-200 rounded text-sm transition-colors">Next</button>`;
      }
      
      paginationControls.innerHTML = controlsHTML;
    }

    function changePage(page) {
      currentPage = page;
      updateTransactionTable();
    }

    function populateCategoryFilter() {
      const categoryFilter = document.getElementById('categoryFilter');
      const categories = [...new Set(allTransactions.map(t => t.category).filter(Boolean))].sort();
      
      categories.forEach(category => {
        const option = document.createElement('option');
        option.value = category;
        option.textContent = category;
        categoryFilter.appendChild(option);
      });
      
      categoryFilter.addEventListener('change', function() {
        const selectedCategory = this.value;
        if (selectedCategory) {
          filteredTransactions = allTransactions.filter(t => t.category === selectedCategory);
        } else {
          filteredTransactions = allTransactions;
        }
        currentPage = 1;
        updateTransactionTable();
      });
    }

    function formatCurrency(amount) {
      return new Intl.NumberFormat('en-US', {
        style: 'currency',
        currency: 'USD'
      }).format(Math.abs(amount));
    }

    function formatDate(dateString) {
      if (!dateString) return 'N/A';
      const date = new Date(dateString);
      return date.toLocaleDateString('en-US', {
        month: 'short',
        day: '2-digit',
        year: 'numeric'
      });
    }

    function setupTimePeriodButtons() {
      const periodButtons = document.querySelectorAll('.period-btn');
      
      periodButtons.forEach(button => {
        button.addEventListener('click', function() {
          const period = parseInt(this.dataset.period);
          currentTimePeriod = period;
          
          // Update button styles
          periodButtons.forEach(btn => {
            btn.classList.remove('bg-white', 'dark:bg-gray-700', 'text-purple-600', 'shadow-sm');
            btn.classList.add('text-gray-600', 'dark:text-gray-300', 'hover:bg-gray-50', 'dark:hover:bg-gray-700');
          });
          
          this.classList.add('bg-white', 'dark:bg-gray-700', 'text-purple-600', 'shadow-sm');
          this.classList.remove('text-gray-600', 'dark:text-gray-300', 'hover:bg-gray-50', 'dark:hover:bg-gray-700');
          
          // Update chart
          updateFinancialChart();
        });
      });
    }
  </script>
</body>
</html>